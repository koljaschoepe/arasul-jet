# Traefik Dynamic Configuration - Middlewares
# Rate limiting, authentication, headers, etc.

http:
  middlewares:
    # Rate Limiting Middlewares

    # n8n Webhooks: 100 requests/minute
    rate-limit-n8n:
      rateLimit:
        average: 100
        period: 1m
        burst: 20

    # LLM API: 10 requests/second
    rate-limit-llm:
      rateLimit:
        average: 10
        period: 1s
        burst: 5

    # Metrics API: 20 requests/second
    rate-limit-metrics:
      rateLimit:
        average: 20
        period: 1s
        burst: 10

    # Auth endpoints: 30 requests/minute (prevent brute force while allowing normal use)
    # Previous: 5/15min was too restrictive, caused login failures
    # Note: Backend also has login attempt tracking in database for security
    rate-limit-auth:
      rateLimit:
        average: 30
        period: 1m
        burst: 10

    # General API: 100 requests/second
    rate-limit-api:
      rateLimit:
        average: 100
        period: 1s
        burst: 50

    # Security Headers
    security-headers:
      headers:
        frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Powered-By: "Arasul Platform"
          Server: ""  # Hide server info

    # CORS Headers
    cors-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowOriginList:
          - "*"  # Adjust for production
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "X-Requested-With"
        accessControlExposeHeaders:
          - "Content-Length"
          - "Content-Type"
        accessControlMaxAge: 3600
        addVaryHeader: true

    # Forward Authentication (JWT validation via cookie or header)
    forward-auth:
      forwardAuth:
        address: "http://dashboard-backend:3001/api/auth/verify"
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Name"
          - "X-User-Email"

    # Strip path prefixes
    strip-minio-prefix:
      stripPrefix:
        prefixes:
          - "/minio"
        forceSlash: false

    # MinIO Headers for reverse proxy
    minio-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-For: ""
          X-Real-IP: ""

    strip-minio-api-prefix:
      stripPrefix:
        prefixes:
          - "/minio-api"
        forceSlash: false

    strip-models-prefix:
      stripPrefix:
        prefixes:
          - "/models"
        forceSlash: false

    strip-embeddings-prefix:
      stripPrefix:
        prefixes:
          - "/embeddings"
        forceSlash: false

    strip-n8n-prefix:
      stripPrefix:
        prefixes:
          - "/n8n"
        forceSlash: false

    # Strip terminal prefix for Claude Code (legacy)
    strip-terminal-prefix:
      stripPrefix:
        prefixes:
          - "/terminal"
        forceSlash: false

    # Strip claude-terminal prefix for Claude Code
    strip-claude-terminal-prefix:
      stripPrefix:
        prefixes:
          - "/claude-terminal"
        forceSlash: false

    # Compression
    compress:
      compress:
        excludedContentTypes:
          - "text/event-stream"
          - "application/grpc"

    # Retry middleware
    retry:
      retry:
        attempts: 3
        initialInterval: 100ms

    # Circuit breaker
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.5 || ResponseCodeRatio(500, 600, 0, 600) > 0.25"
        checkPeriod: 10s
        fallbackDuration: 30s
        recoveryDuration: 60s

    # IP Whitelist (for admin routes)
    admin-whitelist:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "172.30.0.0/24"  # Docker network
          - "192.168.0.0/16"  # Local network
          - "10.0.0.0/8"      # Private network

    # Redirect to HTTPS
    redirect-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Add trailing slash
    add-trailing-slash:
      redirectRegex:
        regex: "^(https?://[^/]+/[a-z0-9_]+)$"
        replacement: "${1}/"
        permanent: true

    # Basic Auth for Traefik Dashboard
    # Default credentials: admin / arasul123 (change in production!)
    # Generated with: htpasswd -nb admin arasul123
    basicAuth-traefik:
      basicAuth:
        users:
          - "admin:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"  # admin:arasul123
        realm: "Traefik Dashboard"
        removeHeader: true

    # Basic Auth for n8n
    # Default credentials: admin / arasul123 (change in production!)
    # Generated with: scripts/generate_htpasswd.sh admin arasul123
    basicAuth-n8n:
      basicAuth:
        users:
          - "admin:$$2y$$05$$8/O2kAXWJKaWJz71NIAaHO41AuS1fJIsJxvh5wyc0tNYntcu7rt9y"
        realm: "n8n Workflow Engine"
        removeHeader: true
