# Traefik Dynamic Configuration - Routes
# HTTP routers and services

http:
  routers:
    # Dashboard Frontend (catch-all, lowest priority) - HTTP only
    dashboard-frontend:
      rule: "PathPrefix(`/`)"
      service: dashboard-frontend-service
      priority: 1
      entryPoints:
        - web

    # Dashboard Frontend (catch-all, lowest priority) - HTTPS
    dashboard-frontend-secure:
      rule: "PathPrefix(`/`)"
      service: dashboard-frontend-service
      priority: 1
      entryPoints:
        - websecure
      tls: {}

    # Dashboard Backend API - HTTP
    dashboard-api:
      rule: "PathPrefix(`/api`)"
      service: dashboard-backend-service
      priority: 10
      middlewares:
        - security-headers
        - rate-limit-api
        - compress
      entryPoints:
        - web

    # Dashboard Backend API - HTTPS
    dashboard-api-secure:
      rule: "PathPrefix(`/api`)"
      service: dashboard-backend-service
      priority: 10
      middlewares:
        - security-headers
        - rate-limit-api
        - compress
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Auth endpoints (with stricter rate limiting) - HTTP
    auth-api:
      rule: "PathPrefix(`/api/auth`)"
      service: dashboard-backend-service
      priority: 20
      middlewares:
        - security-headers
        - rate-limit-auth
      entryPoints:
        - web

    # Auth endpoints - HTTPS
    auth-api-secure:
      rule: "PathPrefix(`/api/auth`)"
      service: dashboard-backend-service
      priority: 20
      middlewares:
        - security-headers
        - rate-limit-auth
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Metrics API (with rate limiting) - HTTP
    metrics-api:
      rule: "PathPrefix(`/api/metrics`)"
      service: dashboard-backend-service
      priority: 15
      middlewares:
        - security-headers
        - rate-limit-metrics
        - compress
      entryPoints:
        - web

    # Metrics API - HTTPS
    metrics-api-secure:
      rule: "PathPrefix(`/api/metrics`)"
      service: dashboard-backend-service
      priority: 15
      middlewares:
        - security-headers
        - rate-limit-metrics
        - compress
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # MinIO Console
    # Accessible from any IP address in the network via HTTP and HTTPS
    minio-console:
      rule: "PathPrefix(`/minio`)"
      service: minio-console-service
      priority: 100
      middlewares:
        - minio-headers
        - rate-limit-api
      entryPoints:
        - web
        - websecure
      tls: {}

    # MinIO S3 API
    # Accessible from any IP address in the network via HTTP and HTTPS
    minio-api:
      rule: "PathPrefix(`/minio-api`)"
      service: minio-api-service
      priority: 30
      middlewares:
        - strip-minio-api-prefix
        - security-headers
        - cors-headers
        - rate-limit-api
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # LLM Service Direct Access
    # Accessible from any IP address in the network via HTTP and HTTPS
    llm-direct:
      rule: "PathPrefix(`/models`)"
      service: llm-service
      priority: 25
      middlewares:
        - strip-models-prefix
        - rate-limit-llm
        - security-headers
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # Embeddings Service Direct Access
    # Accessible from any IP address in the network via HTTP and HTTPS
    embeddings-direct:
      rule: "PathPrefix(`/embeddings`)"
      service: embeddings-service
      priority: 25
      middlewares:
        - strip-embeddings-prefix
        - rate-limit-llm
        - security-headers
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # n8n Workflow Engine
    # Accessible from any IP address in the network via HTTP and HTTPS
    n8n:
      rule: "PathPrefix(`/n8n`)"
      service: n8n-service
      priority: 20
      middlewares:
        - strip-n8n-prefix
        - security-headers
        - rate-limit-api
      entryPoints:
        - web
        - websecure
      tls: {}

    # n8n Webhooks (with rate limiting)
    # Accessible from any IP address in the network via HTTP and HTTPS
    n8n-webhooks:
      rule: "PathPrefix(`/webhook`)"
      service: n8n-service
      priority: 25
      middlewares:
        - rate-limit-n8n
        - security-headers
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard (secured with Basic Auth)
    # Accessible from any IP address in the network via HTTP and HTTPS
    traefik-dashboard:
      rule: "(PathPrefix(`/api/traefik`) || PathPrefix(`/dashboard`))"
      service: api@internal
      priority: 35
      middlewares:
        - basicAuth-traefik
        - security-headers
        - rate-limit-auth
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

  services:
    # Dashboard Frontend
    dashboard-frontend-service:
      loadBalancer:
        servers:
          - url: "http://dashboard-frontend:3000"
        healthCheck:
          path: /
          interval: 30s
          timeout: 3s

    # Dashboard Backend
    dashboard-backend-service:
      loadBalancer:
        servers:
          - url: "http://dashboard-backend:3001"
        healthCheck:
          path: /api/health
          interval: 10s
          timeout: 2s
        responseForwarding:
          flushInterval: 100ms
        passHostHeader: true

    # MinIO Console
    minio-console-service:
      loadBalancer:
        servers:
          - url: "http://minio:9001"
        healthCheck:
          path: /
          interval: 30s
          timeout: 3s

    # MinIO S3 API
    minio-api-service:
      loadBalancer:
        servers:
          - url: "http://minio:9000"
        healthCheck:
          path: /minio/health/live
          interval: 30s
          timeout: 3s

    # LLM Service (Ollama on port 11434)
    llm-service:
      loadBalancer:
        servers:
          - url: "http://llm-service:11434"
        healthCheck:
          path: /api/tags
          interval: 30s
          timeout: 5s

    # Embeddings Service
    embeddings-service:
      loadBalancer:
        servers:
          - url: "http://embedding-service:11435"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # n8n
    n8n-service:
      loadBalancer:
        servers:
          - url: "http://n8n:5678"
        healthCheck:
          path: /healthz
          interval: 30s
          timeout: 3s
