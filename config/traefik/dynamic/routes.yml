# Traefik Dynamic Configuration - Routes
# HTTP routers and services

http:
  routers:
    # Dashboard Frontend (catch-all, lowest priority) - HTTP only
    dashboard-frontend:
      rule: "PathPrefix(`/`) && !PathPrefix(`/claude-terminal`)"
      service: dashboard-frontend-service
      priority: 1
      entryPoints:
        - web

    # Dashboard Frontend (catch-all, lowest priority) - HTTPS
    dashboard-frontend-secure:
      rule: "PathPrefix(`/`) && !PathPrefix(`/claude-terminal`)"
      service: dashboard-frontend-service
      priority: 1
      entryPoints:
        - websecure
      tls: {}

    # Dashboard Backend API - HTTP
    dashboard-api:
      rule: "PathPrefix(`/api`)"
      service: dashboard-backend-service
      priority: 10
      middlewares:
        - security-headers
        - rate-limit-api
        - compress
      entryPoints:
        - web

    # Dashboard Backend API - HTTPS
    dashboard-api-secure:
      rule: "PathPrefix(`/api`)"
      service: dashboard-backend-service
      priority: 10
      middlewares:
        - security-headers
        - rate-limit-api
        - compress
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Auth endpoints (with stricter rate limiting) - HTTP
    auth-api:
      rule: "PathPrefix(`/api/auth`)"
      service: dashboard-backend-service
      priority: 20
      middlewares:
        - security-headers
        - rate-limit-auth
      entryPoints:
        - web

    # Auth endpoints - HTTPS
    auth-api-secure:
      rule: "PathPrefix(`/api/auth`)"
      service: dashboard-backend-service
      priority: 20
      middlewares:
        - security-headers
        - rate-limit-auth
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Metrics API (with rate limiting) - HTTP
    metrics-api:
      rule: "PathPrefix(`/api/metrics`)"
      service: dashboard-backend-service
      priority: 15
      middlewares:
        - security-headers
        - rate-limit-metrics
        - compress
      entryPoints:
        - web

    # Metrics API - HTTPS
    metrics-api-secure:
      rule: "PathPrefix(`/api/metrics`)"
      service: dashboard-backend-service
      priority: 15
      middlewares:
        - security-headers
        - rate-limit-metrics
        - compress
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # MinIO Console
    # Accessible from any IP address in the network via HTTP and HTTPS
    minio-console:
      rule: "PathPrefix(`/minio`)"
      service: minio-console-service
      priority: 100
      middlewares:
        - minio-headers
        - rate-limit-api
      entryPoints:
        - web
        - websecure
      tls: {}

    # MinIO S3 API
    # Accessible from any IP address in the network via HTTP and HTTPS
    minio-api:
      rule: "PathPrefix(`/minio-api`)"
      service: minio-api-service
      priority: 30
      middlewares:
        - strip-minio-api-prefix
        - security-headers
        - cors-headers
        - rate-limit-api
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # LLM Service Direct Access
    # Accessible from any IP address in the network via HTTP and HTTPS
    llm-direct:
      rule: "PathPrefix(`/models`)"
      service: llm-service
      priority: 25
      middlewares:
        - strip-models-prefix
        - rate-limit-llm
        - security-headers
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # Embeddings Service Direct Access
    # Accessible from any IP address in the network via HTTP and HTTPS
    embeddings-direct:
      rule: "PathPrefix(`/embeddings`)"
      service: embeddings-service
      priority: 25
      middlewares:
        - strip-embeddings-prefix
        - rate-limit-llm
        - security-headers
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # Claude Code Web Terminal - HTTP
    # Protected by forward-auth (requires dashboard login)
    # Note: No strip-prefix middleware - ttyd uses --base-path /claude-terminal
    claude-terminal:
      rule: "PathPrefix(`/claude-terminal`)"
      service: claude-terminal-service
      priority: 100
      middlewares:
        - forward-auth
      entryPoints:
        - web

    # Claude Code Web Terminal - HTTPS
    # Note: No strip-prefix middleware - ttyd uses --base-path /claude-terminal
    claude-terminal-secure:
      rule: "PathPrefix(`/claude-terminal`)"
      service: claude-terminal-service
      priority: 100
      middlewares:
        - forward-auth
      entryPoints:
        - websecure
      tls: {}

    # n8n Root Redirect - HTTP
    # Exact match for /n8n or /n8n/ redirects to /signin (fixes 404 on first access)
    # Priority 110 ensures this matches before the general /n8n/* route
    n8n-root-http:
      rule: "Path(`/n8n`) || Path(`/n8n/`)"
      service: n8n-service
      priority: 110
      middlewares:
        - n8n-root-to-signin
        - security-headers
      entryPoints:
        - web

    # n8n Root Redirect - HTTPS
    n8n-root-https:
      rule: "Path(`/n8n`) || Path(`/n8n/`)"
      service: n8n-service
      priority: 110
      middlewares:
        - n8n-root-to-signin
        - security-headers
      entryPoints:
        - websecure
      tls: {}

    # n8n Workflow Engine - HTTP
    # Traefik strips /n8n prefix before forwarding to n8n (n8n runs on root)
    # No forward-auth: n8n handles its own authentication
    n8n-http:
      rule: "PathPrefix(`/n8n`)"
      service: n8n-service
      priority: 100
      middlewares:
        - strip-n8n-prefix
        - security-headers
      entryPoints:
        - web

    # n8n Workflow Engine - HTTPS
    # No forward-auth: n8n handles its own authentication
    n8n-https:
      rule: "PathPrefix(`/n8n`)"
      service: n8n-service
      priority: 100
      middlewares:
        - strip-n8n-prefix
        - security-headers
      entryPoints:
        - websecure
      tls: {}

    # n8n SPA routes - These paths are used by n8n's frontend router
    # Without this, navigating to /signin would hit the dashboard frontend
    # No forward-auth: n8n handles its own authentication
    # NOTE: /settings, /users, /variables removed to avoid conflict with Arasul dashboard
    # n8n internal navigation still works via client-side SPA routing
    n8n-spa-http:
      rule: "PathPrefix(`/signin`) || PathPrefix(`/setup`) || PathPrefix(`/forgot-password`) || PathPrefix(`/workflows`) || PathPrefix(`/credentials`) || PathPrefix(`/executions`) || PathPrefix(`/personal-data`)"
      service: n8n-service
      priority: 90
      middlewares:
        - security-headers
      entryPoints:
        - web

    # n8n SPA routes - HTTPS
    # No forward-auth: n8n handles its own authentication
    n8n-spa-https:
      rule: "PathPrefix(`/signin`) || PathPrefix(`/setup`) || PathPrefix(`/forgot-password`) || PathPrefix(`/workflows`) || PathPrefix(`/credentials`) || PathPrefix(`/executions`) || PathPrefix(`/personal-data`)"
      service: n8n-service
      priority: 90
      middlewares:
        - security-headers
      entryPoints:
        - websecure
      tls: {}

    # n8n Assets - HTTP (served directly without prefix)
    # No forward-auth: Assets must load for signin page to work
    n8n-assets-http:
      rule: "PathPrefix(`/assets`) && !PathPrefix(`/api`)"
      service: n8n-service
      priority: 50
      entryPoints:
        - web

    # n8n Assets - HTTPS
    # No forward-auth: Assets must load for signin page to work
    n8n-assets-https:
      rule: "PathPrefix(`/assets`) && !PathPrefix(`/api`)"
      service: n8n-service
      priority: 50
      entryPoints:
        - websecure
      tls: {}

    # Dashboard Frontend Static Files - HTTP
    # These must have higher priority than n8n-static to serve React bundles
    dashboard-static-http:
      rule: "PathPrefix(`/static/js`) || PathPrefix(`/static/css`) || PathPrefix(`/static/media`)"
      service: dashboard-frontend-service
      priority: 65
      entryPoints:
        - web

    # Dashboard Frontend Static Files - HTTPS
    dashboard-static-https:
      rule: "PathPrefix(`/static/js`) || PathPrefix(`/static/css`) || PathPrefix(`/static/media`)"
      service: dashboard-frontend-service
      priority: 65
      entryPoints:
        - websecure
      tls: {}

    # n8n Static files - HTTP
    # No forward-auth: Static files must load for signin page
    n8n-static-http:
      rule: "PathPrefix(`/static`)"
      service: n8n-service
      priority: 60
      entryPoints:
        - web

    # n8n Static files - HTTPS
    # No forward-auth: Static files must load for signin page
    n8n-static-https:
      rule: "PathPrefix(`/static`)"
      service: n8n-service
      priority: 60
      entryPoints:
        - websecure
      tls: {}

    # n8n REST API - HTTP
    # No forward-auth: n8n handles its own authentication
    n8n-rest-http:
      rule: "PathPrefix(`/rest`)"
      service: n8n-service
      priority: 50
      middlewares:
        - security-headers
      entryPoints:
        - web

    # n8n REST API - HTTPS
    # No forward-auth: n8n handles its own authentication
    n8n-rest-https:
      rule: "PathPrefix(`/rest`)"
      service: n8n-service
      priority: 50
      middlewares:
        - security-headers
      entryPoints:
        - websecure
      tls: {}

    # n8n favicon - HTTP
    # No forward-auth: favicon must load publicly
    n8n-favicon-http:
      rule: "Path(`/favicon.ico`)"
      service: n8n-service
      priority: 85
      entryPoints:
        - web

    # n8n favicon - HTTPS
    n8n-favicon-https:
      rule: "Path(`/favicon.ico`)"
      service: n8n-service
      priority: 85
      entryPoints:
        - websecure
      tls: {}

    # n8n Webhooks (with rate limiting)
    # Accessible from any IP address in the network via HTTP and HTTPS
    n8n-webhooks:
      rule: "PathPrefix(`/webhook`)"
      service: n8n-service
      priority: 25
      middlewares:
        - rate-limit-n8n
        - security-headers
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

    # Traefik Dashboard (secured with Basic Auth)
    # Accessible from any IP address in the network via HTTP and HTTPS
    traefik-dashboard:
      rule: "(PathPrefix(`/api/traefik`) || PathPrefix(`/dashboard`))"
      service: api@internal
      priority: 35
      middlewares:
        - basicAuth-traefik
        - security-headers
        - rate-limit-auth
      entryPoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt

  services:
    # Dashboard Frontend
    dashboard-frontend-service:
      loadBalancer:
        servers:
          - url: "http://dashboard-frontend:3000"
        healthCheck:
          path: /
          interval: 30s
          timeout: 3s

    # Dashboard Backend
    dashboard-backend-service:
      loadBalancer:
        servers:
          - url: "http://dashboard-backend:3001"
        healthCheck:
          path: /api/health
          interval: 10s
          timeout: 2s
        responseForwarding:
          flushInterval: 100ms
        passHostHeader: true

    # MinIO Console
    minio-console-service:
      loadBalancer:
        servers:
          - url: "http://minio:9001"
        healthCheck:
          path: /
          interval: 30s
          timeout: 3s

    # MinIO S3 API
    minio-api-service:
      loadBalancer:
        servers:
          - url: "http://minio:9000"
        healthCheck:
          path: /minio/health/live
          interval: 30s
          timeout: 3s

    # LLM Service (Ollama on port 11434)
    llm-service:
      loadBalancer:
        servers:
          - url: "http://llm-service:11434"
        healthCheck:
          path: /api/tags
          interval: 30s
          timeout: 5s

    # Embeddings Service
    embeddings-service:
      loadBalancer:
        servers:
          - url: "http://embedding-service:11435"
        healthCheck:
          path: /health
          interval: 30s
          timeout: 5s

    # n8n
    # Note: API endpoints (like /healthz) are NOT prefixed with N8N_PATH
    # Only the frontend UI uses the /n8n/ prefix
    n8n-service:
      loadBalancer:
        servers:
          - url: "http://n8n:5678"
        healthCheck:
          path: /healthz
          interval: 30s
          timeout: 3s

    # Claude Code Web Terminal
    claude-terminal-service:
      loadBalancer:
        servers:
          - url: "http://claude-code:7681"
        passHostHeader: true
