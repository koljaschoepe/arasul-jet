# Traefik Dynamic Configuration - WebSocket Support
# Explicit WebSocket routing and configuration

http:
  routers:
    # Dashboard WebSocket (metrics live-stream)
    # LAN-accessible: Host restriction removed to allow access via IP address
    dashboard-websocket:
      rule: "PathPrefix(`/api/metrics/live-stream`)"
      service: dashboard-backend-service
      priority: 50
      middlewares:
        - security-headers
      entryPoints:
        - web
        - websecure
      tls: {}

    # n8n WebSocket
    # LAN-accessible: Host restriction removed to allow access via IP address
    n8n-websocket:
      rule: "PathPrefix(`/n8n/`) && Headers(`Upgrade`, `websocket`)"
      service: n8n-service
      priority: 50
      middlewares:
        - strip-n8n-prefix
        - security-headers
      entryPoints:
        - web
        - websecure
      tls: {}

    # Claude Code Terminal WebSocket - HTTP
    # Protected by forward-auth, accessible via LAN
    claude-terminal-websocket:
      rule: "PathPrefix(`/claude-terminal`) && Headers(`Upgrade`, `websocket`)"
      service: claude-terminal-service
      priority: 110
      middlewares:
        - forward-auth
        - strip-claude-terminal-prefix
      entryPoints:
        - web

    # Claude Code Terminal WebSocket - HTTPS
    claude-terminal-websocket-secure:
      rule: "PathPrefix(`/claude-terminal`) && Headers(`Upgrade`, `websocket`)"
      service: claude-terminal-service
      priority: 110
      middlewares:
        - forward-auth
        - strip-claude-terminal-prefix
      entryPoints:
        - websecure
      tls: {}

  middlewares:
    # WebSocket-specific headers
    websocket-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-WebSocket-Enabled: "true"

  services:
    # Note: Services are already defined in routes.yml
    # WebSocket support is automatic when:
    # 1. Connection: Upgrade header is present
    # 2. Upgrade: websocket header is present
    # Traefik automatically handles the upgrade
